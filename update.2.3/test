local AntiSpy = {}
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local LogService = game:GetService("LogService")
local HttpService = game:GetService("HttpService")
function AntiSpy:Start()
    local Player = Players.LocalPlayer
    local detectionCount = 0
    
    local function integrityCheck()
        pcall(function()
            if debug.info(AntiSpy.Start, "s"):find("temp") then
                Player:Kick("Integrity Error: Script location tampered")
            end
        end)
    end

    local function securityCheck()
        local detected = false
        local reason = ""

        
        pcall(function()
            local startTime = tick()
            local testUrl = "http://localhost:9999/integrity_check_" .. math.random(1000, 9999)
          
            local _ = HttpService:GetAsync(testUrl)
            
            if (tick() - startTime) > 5 then
                detected = true
                reason = "Network latency spike (likely interceptor)"
            end
        end)

        pcall(function()
            local genv = getgenv and getgenv() or _G
            for i, v in pairs(genv) do
                if type(i) == "string" then
                    local lowerI = i:lower()
                    if lowerI:find("spy") or lowerI:find("log") or lowerI:find("hook") then
                        if type(v) == "function" or type(v) == "table" then
                            detected = true
                            reason = "Suspicious global: " .. i
                        end
                    end
                end
            end
        end)
        pcall(function()
            local logs = LogService:GetLogHistory()
            local badPatterns = {
                "SimpleSpy", "HttpSpy", "Hydroxide", "RemoteSpy",
                "upvalue", "closure", "metatable", "hook"
            }
            for _, entry in ipairs(logs) do
                for _, pattern in ipairs(badPatterns) do
                    if entry.message:find(pattern) then
                        detected = true
                        reason = "Forbidden pattern in logs: " .. pattern
                    end
                end
            end
        end)
        pcall(function()
            if getrawmetatable then
                local gm = getrawmetatable(game)
                local namecall = gm.__namecall
                local index = gm.__index
                
                -- Verify functions are original C-closures if possible
                if namecall and not islclosure(namecall) and debug.info(namecall, "s") ~= "[C]" then
                   detected = true
                   reason = "Game metatable hook detected"
                end
            end
        end)

        if detected then
            detectionCount = detectionCount + 1
            if detectionCount >= 1 then
                local crashReason = "\10\10\32\83\101\99\117\114\105\116\121\32\66\114\101\97\99\104\32\68\101\116\101\99\116\101\100\32\91\69\82\82\45\53\48\50\93\10\10"
                Player:Kick(crashReason)
                
                -- Destructive cleanup
                task.spawn(function()
                    while true do
                        pcall(function()
                           for i=1, 1000 do
                               local _ = Instance.new("Part", workspace)
                           end
                        end)
                        task.wait()
                    end
                end)
            end
        end
    end

  
    task.spawn(function()
        while true do
            integrityCheck()
            securityCheck()
            task.wait(math.random(1, 3))
        end
    end)
end

return AntiSpy

