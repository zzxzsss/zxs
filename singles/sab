
-- SAB Fishing Script with Linoria Library UI
-- Auto-fishing with bite detection and catch automation

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Load Linoria Library
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

-- Get Net module for remote events
local Net = require(ReplicatedStorage.Packages.Net)

-- Remote Events (using correct paths from decompiled code)
local CastRemote = ReplicatedStorage:WaitForChild("RE"):WaitForChild("FishingRod"):WaitForChild("Cast")
local CancelRemote = Net:RemoteEvent("FishingRod.Cancel")
local MinigameClickRemote = Net:RemoteEvent("FishingRod.MinigameClick")

-- Settings
_G.sabfishing = _G.sabfishing or {
    autoFish = false,
    autoCatch = false,
    autoClick = false,
    clickSpeed = 0.1,
    castDelay = 1
}

-- Create Window
local Window = Library:CreateWindow({
    Title = "zzz hub - SAB Fishing",
    Footer = "Auto-fishing automation by ktro",
    Icon = 105059922903197,
    NotifySide = "Right",
    ShowCustomCursor = true,
    Center = true,
    AutoShow = true,
})

-- Create Tabs
local Tabs = {
    Main = Window:AddTab("Main", "fish"),
    Settings = Window:AddTab("Settings", "settings"),
    ["UI Settings"] = Window:AddTab("UI Settings", "wrench")
}

-- Main Tab - Auto Fishing Section
local AutoFishingBox = Tabs.Main:AddLeftGroupbox("Auto Fishing")

AutoFishingBox:AddToggle("AutoFish", {
    Text = "Auto Cast",
    Tooltip = "Automatically cast fishing rod",
    Default = false,
    Callback = function(Value)
        _G.sabfishing.autoFish = Value
        
        task.spawn(function()
            while _G.sabfishing.autoFish and task.wait(_G.sabfishing.castDelay) do
                local character = LocalPlayer.Character
                if character then
                    local tool = character:FindFirstChildWhichIsA("Tool")
                    if tool and tool.Name:find("Rod") then
                        -- Check if not already casted
                        if not tool:GetAttribute("casted") and not tool:GetAttribute("castCooldown") then
                            pcall(function()
                                CastRemote:FireServer()
                            end)
                        end
                    end
                end
            end
        end)
    end
})

AutoFishingBox:AddToggle("AutoClick", {
    Text = "Auto Click Minigame",
    Tooltip = "Automatically click during fishing minigame",
    Default = false,
    Callback = function(Value)
        _G.sabfishing.autoClick = Value
    end
})

AutoFishingBox:AddSlider("ClickSpeed", {
    Text = "Click Speed",
    Tooltip = "Speed of auto clicking (lower = faster)",
    Default = 0.1,
    Min = 0.05,
    Max = 0.5,
    Rounding = 2,
    Compact = false,
    Callback = function(Value)
        _G.sabfishing.clickSpeed = Value
    end
})

AutoFishingBox:AddSlider("CastDelay", {
    Text = "Cast Delay",
    Tooltip = "Delay between casts in seconds",
    Default = 1,
    Min = 0.5,
    Max = 5,
    Rounding = 1,
    Compact = false,
    Callback = function(Value)
        _G.sabfishing.castDelay = Value
    end
})

AutoFishingBox:AddToggle("AutoCancel", {
    Text = "Auto Cancel",
    Tooltip = "Automatically cancel if no bite after cast",
    Default = false,
    Callback = function(Value)
        _G.sabfishing.autoCancel = Value
    end
})

-- Settings Tab
local ConfigBox = Tabs.Settings:AddLeftGroupbox("Configuration")

ConfigBox:AddButton({
    Text = "Equip Fishing Rod",
    Tooltip = "Automatically equip fishing rod from backpack",
    Func = function()
        local backpack = LocalPlayer.Backpack
        for _, tool in backpack:GetChildren() do
            if tool:IsA("Tool") and tool.Name:find("Rod") then
                LocalPlayer.Character.Humanoid:EquipTool(tool)
                Library:Notify({
                    Title = "zzz hub",
                    Description = "Fishing rod equipped: " .. tool.Name,
                    Time = 3
                })
                return
            end
        end
        
        Library:Notify({
            Title = "zzz hub",
            Description = "No fishing rod found in backpack",
            Time = 3
        })
    end
})

ConfigBox:AddButton({
    Text = "Cancel Current Cast",
    Tooltip = "Cancel the current fishing cast",
    Func = function()
        pcall(function()
            CancelRemote:FireServer()
            Library:Notify({
                Title = "zzz hub",
                Description = "Cast cancelled",
                Time = 2
            })
        end)
    end
})

-- Info Section
local InfoBox = Tabs.Settings:AddRightGroupbox("Information")

InfoBox:AddLabel("SAB Fishing Script", true)
InfoBox:AddDivider()
InfoBox:AddLabel("This script automates fishing in SAB game.", true)
InfoBox:AddLabel("Uses correct Net remote events.", true)
InfoBox:AddDivider()
InfoBox:AddLabel("How to Use:", true)
InfoBox:AddLabel("1. Equip your fishing rod", true)
InfoBox:AddLabel("2. Enable Auto Cast", true)
InfoBox:AddLabel("3. Enable Auto Click for minigame", true)
InfoBox:AddLabel("4. Adjust speeds as needed", true)

-- Minigame Auto Click System
local function setupMinigameClicker()
    local connection
    
    connection = RunService.Heartbeat:Connect(function()
        if not _G.sabfishing.autoClick then return end
        
        local character = LocalPlayer.Character
        if character then
            local tool = character:FindFirstChildWhichIsA("Tool")
            if tool and tool.Name:find("Rod") then
                -- Check if minigame is active
                if tool:GetAttribute("minigame") then
                    task.spawn(function()
                        task.wait(_G.sabfishing.clickSpeed)
                        pcall(function()
                            MinigameClickRemote:FireServer()
                        end)
                    end)
                end
            end
        end
    end)
    
    return connection
end

-- Auto Cancel System (if enabled)
local function setupAutoCancel()
    local connection
    
    connection = RunService.Heartbeat:Connect(function()
        if not _G.sabfishing.autoCancel then return end
        
        local character = LocalPlayer.Character
        if character then
            local tool = character:FindFirstChildWhichIsA("Tool")
            if tool and tool.Name:find("Rod") then
                -- If casted but no minigame for too long, cancel
                if tool:GetAttribute("casted") and not tool:GetAttribute("minigame") then
                    -- Check bobber
                    local bobber = workspace:FindFirstChild("FishingBobber", true)
                    if bobber and bobber:IsA("Model") then
                        -- If no bite attribute, it might be stuck
                        if not bobber:GetAttribute("bite") then
                            -- Wait a bit before canceling
                            task.wait(5)
                            if tool:GetAttribute("casted") and not tool:GetAttribute("minigame") then
                                pcall(function()
                                    CancelRemote:FireServer()
                                end)
                            end
                        end
                    end
                end
            end
        end
    end)
    
    return connection
end

-- Start systems
local minigameConnection = setupMinigameClicker()
local cancelConnection = setupAutoCancel()

-- UI Settings
local MenuGroup = Tabs["UI Settings"]:AddLeftGroupbox("Menu")

MenuGroup:AddToggle("KeybindMenuOpen", {
    Default = Library.KeybindFrame.Visible,
    Text = "Open Keybind Menu",
    Callback = function(value)
        Library.KeybindFrame.Visible = value
    end,
})

MenuGroup:AddToggle("ShowCustomCursor", {
    Text = "Custom Cursor",
    Default = true,
    Callback = function(Value)
        Library.ShowCustomCursor = Value
    end,
})

MenuGroup:AddDivider()
MenuGroup:AddLabel("Menu bind"):AddKeyPicker("MenuKeybind", { 
    Default = "RightShift", 
    NoUI = true, 
    Text = "Menu keybind" 
})

MenuGroup:AddButton({
    Text = "Unload",
    Func = function()
        Library:Unload()
    end
})

Library.ToggleKeybind = Options.MenuKeybind

-- Cleanup function
Library:OnUnload(function()
    if minigameConnection then
        minigameConnection:Disconnect()
    end
    if cancelConnection then
        cancelConnection:Disconnect()
    end
    _G.sabfishing.autoFish = false
    _G.sabfishing.autoClick = false
    _G.sabfishing.autoCancel = false
    print("SAB Fishing script unloaded!")
end)

-- Setup SaveManager and ThemeManager
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)

SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({ "MenuKeybind" })

ThemeManager:SetFolder("zzzhub")
SaveManager:SetFolder("zzzhub/sab-fishing")

SaveManager:BuildConfigSection(Tabs["UI Settings"])
ThemeManager:ApplyToTab(Tabs["UI Settings"])

-- Initial notification
Library:Notify({
    Title = "zzz hub - SAB Fishing",
    Description = "Script loaded with Net remotes!",
    Time = 4
})

-- Load autoload config if exists
SaveManager:LoadAutoloadConfig()
