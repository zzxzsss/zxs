-- Ultra-Fast Auto Buy Script for Steal a Brainrot
-- Maximum speed optimization with parallel processing

local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local Options = Library.Options
local Toggles = Library.Toggles

-- Webhook Configuration
local WEBHOOK_URL = "https://discord.com/api/webhooks/1437293954566721728/W4wJLlHDfa0fUGLwHYIxjfBJUfBVkTkM_u5ccNGBWbJUfE9X9ii6immKU-XhBclc47lQ"

-- Brainrot data with product IDs
local MerchantData = {
	Brainrots = {
		{Brainrot = "Cupcake Koala", StockKey = "Cupcake Koala", Template = "Normal", ProductId = 3450973929},
		{Brainrot = "Doi Doi Do", StockKey = "Doi Doi Do", Template = "Normal", ProductId = 3450973937},
		{Brainrot = "Clickerino Crabo", StockKey = "Clickerino Crabo", Template = "Normal", ProductId = 3450973935},
		{Brainrot = "Stoppo Luminino", StockKey = "Stoppo Luminino", Template = "Normal", ProductId = 3450973930},
		{Brainrot = "Money Money Man", StockKey = "Money Money Man", Template = "Normal", ProductId = 3450973932},
		{Brainrot = "Noo La Polizia", StockKey = "Noo La Polizia", Template = "Normal", ProductId = 3450973934},
		{Brainrot = "Pirulitoita Bicicleteira", StockKey = "Pirulitoita Bicicleteira", Template = "Normal", ProductId = 3450973933},
		{Brainrot = "Los Puggies", StockKey = "Los Puggies", Template = "Normal", ProductId = 3450973936},
		{Brainrot = "Los Spaghettis", StockKey = "Los Spaghettis", Template = "ToiletTemplate"},
		{Brainrot = "Fragrama and Chocrama", StockKey = "Fragrama and Chocrama", Template = "ShakeTemplate"}
	}
}

-- Get Net module for remote calls
local Net = require(ReplicatedStorage.Packages.Net)
local MerchantBuyRemote = Net:RemoteFunction("MerchantService/Buy")

-- Auto buy settings
local autoBuyEnabled = false
local selectedBrainrots = {}
local buyDelay = 0 -- No delay for maximum speed
local useCash = true
local useRobux = false
local purchaseAttempts = 0
local successfulPurchases = 0

-- Function to format stock attribute key
local function formatStockAttribute(brainrotName)
	return "StockEvent_" .. string.gsub(brainrotName, "%s", "_")
end

-- Function to get stock count
local function getStock(brainrotName)
	local stockKey = formatStockAttribute(brainrotName)
	return ReplicatedStorage:GetAttribute(stockKey) or 0
end

-- Function to send webhook notification
local function sendWebhook(itemName)
	task.spawn(function()
		pcall(function()
			local request = syn and syn.request or http and http.request or http_request or request or httprequest
			if request and WEBHOOK_URL ~= "https://discord.com/api/webhooks/1437293954566721728/W4wJLlHDfa0fUGLwHYIxjfBJUfBVkTkM_u5ccNGBWbJUfE9X9ii6immKU-XhBclc47lQ" then
				request({
					Url = WEBHOOK_URL,
					Method = "POST",
					Headers = {
						["Content-Type"] = "application/json"
					},
					Body = HttpService:JSONEncode({
						["embeds"] = {{
							["title"] = "ðŸ§  Brainrot Purchased!",
							["color"] = 65280,
							["fields"] = {
								{
									["name"] = "Item",
									["value"] = "```" .. itemName .. "```",
									["inline"] = false
								}
							},
							["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
						}}
					})
				})
			end
		end)
	end)
end

-- Ultra-fast purchase function - NEVER STOPS, even when out of stock
local function attemptPurchase(index, brainrotData)
	purchaseAttempts = purchaseAttempts + 1

	-- Try cash purchase if enabled (fastest method)
	if useCash then
		task.spawn(function()
			pcall(function()
				local result = MerchantBuyRemote:InvokeServer("2298b248-44dd-4a34-bbfe-e1174e8ae1b4", index)
				if result then
					successfulPurchases = successfulPurchases + 1
					sendWebhook(brainrotData.Brainrot)
				end
			end)
		end)
	end

	-- Try Robux purchase if enabled (parallel with cash)
	if useRobux and brainrotData.ProductId then
		task.spawn(function()
			pcall(function()
				local ShopPurchaseRemote = Net:RemoteEvent("ShopService/Purchase")
				ShopPurchaseRemote:FireServer(brainrotData.ProductId)
				-- Note: No reliable way to confirm Robux purchase success
			end)
		end)
	end

	return true
end

-- Ultra-fast auto buy loop using RenderStepped for maximum speed
local autoBuyConnection
local function startAutoBuy()
	if autoBuyConnection then
		autoBuyConnection:Disconnect()
	end

	-- Use RenderStepped instead of Heartbeat for faster execution
	autoBuyConnection = RunService.RenderStepped:Connect(function()
		if not autoBuyEnabled then return end

		-- INSANE SPAM MODE: 100 concurrent attempts per frame per brainrot
		for i, brainrotData in ipairs(MerchantData.Brainrots) do
			if selectedBrainrots[brainrotData.Brainrot] then
				-- 100 simultaneous purchase attempts for INSANE speed
				for _ = 1, 100 do
					task.spawn(function()
						attemptPurchase(i, brainrotData)
					end)
				end
			end
		end
	end)
end

-- Create UI
local Window = Library:CreateWindow({
	Title = "Steal a Brainrot - ULTRA FAST",
	Footer = "Maximum Speed Purchase System",
	Icon = 95816097006870,
	NotifySide = "Right",
	ShowCustomCursor = true,
})

local Tabs = {
	Main = Window:AddTab("Auto Buy", "zap"),
	Settings = Window:AddTab("Settings", "settings"),
	["UI Settings"] = Window:AddTab("UI Settings", "palette")
}

-- Main tab - Auto Buy controls
local MainGroup = Tabs.Main:AddLeftGroupbox("Auto Buy Controls", "zap")

local timerRunning = false
local timerValue = 8

MainGroup:AddToggle("AutoBuyEnabled", {
	Text = "Enable Ultra-Fast Auto Buy",
	Default = false,
	Tooltip = "Instantly purchase selected brainrots at maximum speed",
	Callback = function(Value)
		autoBuyEnabled = Value
		if Value then
			startAutoBuy()
			Library:Notify({
				Title = "Ultra-Fast Auto Buy",
				Description = "Maximum speed enabled! No delays.",
				Time = 2
			})
		else
			if autoBuyConnection then
				autoBuyConnection:Disconnect()
			end
			Library:Notify({
				Title = "Auto Buy",
				Description = "Auto buy disabled. Attempts: " .. purchaseAttempts .. " | Success: " .. successfulPurchases,
				Time = 3
			})
		end
	end
})

MainGroup:AddDivider()

MainGroup:AddLabel("â±ï¸ Repeating Timer Settings", true)

MainGroup:AddSlider("TimerInterval", {
	Text = "Timer Interval (seconds)",
	Default = 18,
	Min = 1,
	Max = 19,
	Rounding = 0,
	Compact = false,
	Callback = function(Value)
		timerValue = Value
	end
})

MainGroup:AddToggle("AutoBuyTimer", {
	Text = "Enable Repeating Timer",
	Default = false,
	Tooltip = "Cycles: Enable auto-buy for X seconds, then disable for X seconds, repeat",
	Callback = function(Value)
		timerRunning = Value
		
		if Value then
			Library:Notify({
				Title = "Repeating Timer Started",
				Description = "Cycling every " .. timerValue .. " seconds",
				Time = 2
			})
			
			-- Start repeating timer loop
			task.spawn(function()
				while timerRunning do
					-- Turn ON auto buy
					Toggles.AutoBuyEnabled:SetValue(true)
					Library:Notify({
						Title = "Timer: ON Phase",
						Description = "Auto buy active for " .. timerValue .. " seconds",
						Time = 2
					})
					
					task.wait(timerValue)
					
					if not timerRunning then break end
					
					-- Turn OFF auto buy
					Toggles.AutoBuyEnabled:SetValue(false)
					Library:Notify({
						Title = "Timer: OFF Phase",
						Description = "Auto buy paused for " .. timerValue .. " seconds",
						Time = 2
					})
					
					task.wait(timerValue)
				end
				
				-- Clean up when stopped
				Toggles.AutoBuyEnabled:SetValue(false)
				Library:Notify({
					Title = "Repeating Timer Stopped",
					Description = "Auto buy timer disabled",
					Time = 2
				})
			end)
		else
			Library:Notify({
				Title = "Timer Stopped",
				Description = "Repeating timer disabled",
				Time = 2
			})
		end
	end
})

MainGroup:AddDivider()

MainGroup:AddToggle("UseCash", {
	Text = "Use Cash (Fastest)",
	Default = true,
	Tooltip = "Primary purchase method - fastest",
	Callback = function(Value)
		useCash = Value
	end
})

MainGroup:AddToggle("UseRobux", {
	Text = "Use Robux (Parallel)",
	Default = false,
	Tooltip = "Runs alongside cash purchases",
	Risky = true,
	Callback = function(Value)
		useRobux = Value
	end
})

MainGroup:AddDivider()

MainGroup:AddButton("Reset Statistics", function()
	purchaseAttempts = 0
	successfulPurchases = 0
	Library:Notify({
		Title = "Stats Reset",
		Description = "Purchase statistics cleared",
		Time = 2
	})
end)

-- Brainrot selection
local BrainrotGroup = Tabs.Main:AddRightGroupbox("Select Brainrots", "list")

BrainrotGroup:AddLabel("Choose which brainrots to auto-buy:", true)
BrainrotGroup:AddDivider()

for i, brainrotData in ipairs(MerchantData.Brainrots) do
	local brainrotName = brainrotData.Brainrot

	BrainrotGroup:AddToggle("Brainrot_" .. i, {
		Text = brainrotName,
		Default = false,
		Callback = function(Value)
			selectedBrainrots[brainrotName] = Value
		end
	})
end

-- Settings tab
local SettingsGroup = Tabs.Settings:AddLeftGroupbox("Speed Information", "zap")

SettingsGroup:AddLabel("âš¡ INSANE SPEED MODE âš¡", true)
SettingsGroup:AddDivider()
SettingsGroup:AddLabel("â€¢ Zero delay between purchases\nâ€¢ 40 parallel attempts per frame\nâ€¢ RenderStepped for max speed\nâ€¢ NEVER STOPS (even when out of stock)\nâ€¢ WARNING: WILL cause lag", true)
SettingsGroup:AddDivider()
SettingsGroup:AddLabel("This is INSANELY FAST!\nUse at your own risk!", true)

local StatsGroup = Tabs.Settings:AddRightGroupbox("Live Monitor", "activity")

-- Update stock and stats display
task.spawn(function()
	while true do
		task.wait(0.1) -- Update display every 0.5s

		local stockText = "ðŸ“Š Purchase Stats:\n"
		stockText = stockText .. "Attempts: " .. purchaseAttempts .. "\n"
		stockText = stockText .. "Success: " .. successfulPurchases .. "\n\n"
		stockText = stockText .. "ðŸ“¦ Stock Levels:\n"

		for i, brainrotData in ipairs(MerchantData.Brainrots) do
			local stock = getStock(brainrotData.StockKey)
			local status = stock > 0 and "âœ“" or "âœ—"
			local color = stock > 0 and "ðŸŸ¢" or "ðŸ”´"
			stockText = stockText .. color .. " " .. brainrotData.Brainrot .. ": " .. stock .. "\n"
		end

		if StatsGroup.Container:FindFirstChild("StockLabel") then
			StatsGroup.Container.StockLabel:Remove()
		end

		StatsGroup:AddLabel(stockText, true, "StockLabel")

		if Library.Unloaded then break end
	end
end)

-- UI Settings
local MenuGroup = Tabs["UI Settings"]:AddLeftGroupbox("Menu", "wrench")

MenuGroup:AddToggle("ShowCustomCursor", {
	Text = "Custom Cursor",
	Default = true,
	Callback = function(Value)
		Library.ShowCustomCursor = Value
	end
})

MenuGroup:AddDivider()
MenuGroup:AddLabel("Menu bind"):AddKeyPicker("MenuKeybind", {
	Default = "RightShift",
	NoUI = true,
	Text = "Menu keybind"
})

MenuGroup:AddButton("Unload", function()
	if autoBuyConnection then
		autoBuyConnection:Disconnect()
	end
	Library:Unload()
end)

Library.ToggleKeybind = Options.MenuKeybind

-- Theme and Save managers
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({"MenuKeybind"})

ThemeManager:SetFolder("StealABrainrot")
SaveManager:SetFolder("StealABrainrot/AutoBuy")

SaveManager:BuildConfigSection(Tabs["UI Settings"])
ThemeManager:ApplyToTab(Tabs["UI Settings"])

SaveManager:LoadAutoloadConfig()

Library:Notify({
	Title = "âš¡ ULTRA-FAST MODE LOADED âš¡",
	Description = "Zero delays - Maximum speed enabled!",
	Time = 3
})
